<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Browser Reconnection Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .log {
      padding: 4px;
      margin: 2px 0;
    }
    .log.info { color: #4fc1ff; }
    .log.error { color: #f48771; }
    .log.success { color: #a9dc76; }
    .log.ws { color: #ffd866; font-weight: bold; }
    #status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px 20px;
      background: #333;
      border-radius: 5px;
    }
    button {
      margin: 10px 5px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Browser WebSocket Reconnection Test</h1>
  <div id="status">Status: <span id="statusText">Not started</span></div>

  <div>
    <button onclick="startTest()">Start Test</button>
    <button onclick="clearLogs()">Clear Logs</button>
  </div>

  <h2>WebSocket Connections Created:</h2>
  <div id="wsCount" style="font-size: 24px; color: #ffd866;">0</div>

  <h2>Logs:</h2>
  <div id="logs"></div>

  <script type="module">
    // Track WebSocket connections by monkey-patching WebSocket constructor
    let wsCreationCount = 0;
    const originalWebSocket = window.WebSocket;
    window.WebSocket = function(...args) {
      wsCreationCount++;
      log(`üîå NEW WebSocket created (#${wsCreationCount}): ${args[0]}`, 'ws');
      updateWsCount();
      return new originalWebSocket(...args);
    };

    // Import jmri-client (you'll need to serve this file and the built package)
    // For now, we'll create a minimal inline version to test the concept

    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = `log ${type}`;
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(message);
    }

    function updateWsCount() {
      document.getElementById('wsCount').textContent = wsCreationCount;
    }

    function updateStatus(text) {
      document.getElementById('statusText').textContent = text;
    }

    window.clearLogs = function() {
      document.getElementById('logs').innerHTML = '';
      wsCreationCount = 0;
      updateWsCount();
    };

    window.startTest = async function() {
      wsCreationCount = 0;
      updateWsCount();
      log('=== TEST STARTING ===', 'info');
      log('This test will:', 'info');
      log('1. Create a WebSocket connection', 'info');
      log('2. Simulate connection failure', 'info');
      log('3. Verify reconnection attempts create new WebSocket instances', 'info');
      log('', 'info');

      updateStatus('Running...');

      // Import and test the actual jmri-client
      try {
        // Try to import from the built package
        const { JmriClient } = await import('../../dist/esm/index.js');

        log('Creating JmriClient with reconnection enabled...', 'info');
        const client = new JmriClient({
          host: 'localhost',
          port: 9999, // Use a port that doesn't exist
          protocol: 'ws',
          reconnection: {
            enabled: true,
            maxAttempts: 5,
            initialDelay: 1000,
            maxDelay: 5000,
            multiplier: 1.5,
            jitter: false // Disable jitter for predictable testing
          },
          heartbeat: {
            enabled: false // Disable for this test
          }
        });

        // Listen to events
        client.on('connectionStateChanged', (newState, oldState) => {
          log(`State: ${oldState} ‚Üí ${newState}`, 'info');
        });

        client.on('reconnecting', (attempt, delay) => {
          log(`üîÑ Reconnecting (attempt ${attempt}, delay ${delay}ms)`, 'info');
        });

        client.on('error', (error) => {
          log(`Error: ${error.message}`, 'error');
        });

        log('Attempting to connect to non-existent server...', 'info');

        try {
          await client.connect();
        } catch (error) {
          log(`Initial connection failed (expected): ${error.message}`, 'info');
        }

        // Wait 20 seconds to observe reconnection attempts
        log('Waiting 20 seconds to observe reconnection attempts...', 'info');
        await new Promise(resolve => setTimeout(resolve, 20000));

        const expectedConnections = 6; // 1 initial + 5 retries
        const actualConnections = wsCreationCount;

        log('', 'info');
        log('=== TEST RESULTS ===', 'info');
        log(`Expected WebSocket creations: ${expectedConnections}`, 'info');
        log(`Actual WebSocket creations: ${actualConnections}`, actualConnections >= expectedConnections ? 'success' : 'error');

        if (actualConnections >= expectedConnections) {
          log('‚úÖ TEST PASSED: Reconnection is creating new WebSocket instances', 'success');
          updateStatus('PASSED');
        } else {
          log('‚ùå TEST FAILED: Reconnection is NOT creating new WebSocket instances', 'error');
          updateStatus('FAILED');
        }

        await client.disconnect();

      } catch (error) {
        log(`Failed to load jmri-client: ${error.message}`, 'error');
        log('Make sure to build the package first: npm run build', 'error');
        updateStatus('ERROR');
      }
    };
  </script>
</body>
</html>
